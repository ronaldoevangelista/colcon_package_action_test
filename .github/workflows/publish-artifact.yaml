name: execute-publish-artifact

on:
  workflow_call:
    secrets:
      SECRET_GITHUB_TOKEN:
        description: ''
        required: true
    inputs:
      repository-name:
        required: true
        type: string
        description: 'The name of the repository from which to extract dependencies.'
        default: ${{ github.repository }}

defaults:
  run:
    shell: bash

jobs:
  job:
    runs-on: ubuntu-22.04
    steps:
      - name: list publish artifact
        shell: bash
        run: |
          echo $(pwd)
          echo $(ls -1 )

      - name: install dependencies
        run: |
          set -x
          sudo apt-get update -y | true
          sudo apt-get install -y \
                git \
                cmake \
                ninja-build \
                build-essential \
                libboost-program-options-dev \
                libboost-filesystem-dev \
                libboost-graph-dev \
                libboost-system-dev \
                libeigen3-dev \
                libflann-dev \
                libfreeimage-dev \
                libmetis-dev \
                libunwind-dev \
                libunwind8 \
                libgoogle-glog-dev \
                libgtest-dev \
                libsqlite3-dev \
                libglew-dev \
                qtbase5-dev \
                libqt5opengl5-dev \
                libcgal-dev \
                libceres-dev \
                libcgal-dev \
                libfftw3-dev \
                libclfft-dev

      - name: clone colmap repository
        run: |
          git config --global advice.detachedHead false
          COMMAND=$(echo "git clone -b 3.7 https://github.com/colmap/colmap.git colmap")
          echo " Downloading: $COMMAND"
          $COMMAND

      - name: configure and build
        run: |
          set -x
          cmake --version
          mkdir -p build install
          echo $(ls -1)
          cd build
          cmake ../colmap \
            -GNinja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=./install \
            -DCMAKE_CUDA_ARCHITECTURES=50 \
            -DTESTS_ENABLED=OFF \
            -DCUDA_ENABLED=false \
            -DGUI_ENABLED=false \
            -DASAN_ENABLED=false
          ninja -k 10000
          ninja install

      - name: compress and publish
        run: |
          set -x
          echo $(pwd)
          echo $(ls -1 )
          tar -czvf colmap.tar.gz ./install/


      - name: publicar artefato
        uses: actions/upload-artifact@v4
        with:
          name: colmap-artifact
          path:  colmap.tar.gz
          retention-days: 1
          overwrite: true
